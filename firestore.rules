rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Reguły dla kolekcji 'companies'
    match /companies/{companyId} {
      // KTO MOŻE CZYTAĆ DANE O FIRMIE?
      // 1. Super Admin (może czytać dane wszystkich firm).
      // 2. LUB pracownik tej firmy (może czytać dane tylko swojej firmy).
      allow read: if request.auth != null && 
                    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin' || 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId);
      
      // KTO MOŻE STWORZYĆ FIRMĘ?
      // Każdy zalogowany użytkownik może stworzyć nową firmę podczas rejestracji.
      allow create: if request.auth != null;

      // KTO MOŻE AKTUALIZOWAĆ DANE FIRMY? (np. listę włączonych agentów)
      // Tylko i wyłącznie Super Admin.
      allow update: if request.auth != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin';
      
      // Na razie nikt nie może usuwać firm z poziomu aplikacji.
      allow delete: if false;
    }

    // Reguły dla kolekcji 'users'
    match /users/{userId} {
      // KTO MOŻE CZYTAĆ DANE UŻYTKOWNIKÓW?
      // 1. Użytkownik może czytać SWÓJ WŁASNY profil.
      // 2. LUB Admin firmy może CZYTAĆ profile wszystkich pracowników SWOJEJ firmy.
      // 3. LUB Super Admin może czytać profile wszystkich użytkowników.
      allow read: if request.auth != null &&
                   (request.auth.uid == userId ||
                    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'company-admin' &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == resource.data.companyId) ||
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin');
      
      // KTO MOŻE STWORZYĆ UŻYTKOWNIKA?
      // Każdy może stworzyć swój profil podczas rejestracji.
      // (Tworzenie sub-kont będzie obsługiwane przez bezpieczną Cloud Function).
      allow create: if true;

      // KTO MOŻE EDYTOWAĆ UŻYTKOWNIKA?
      // Na razie tylko użytkownik może edytować swój własny profil.
      allow update: if request.auth != null && request.auth.uid == userId;

      // Na razie nikt nie może usuwać użytkowników z poziomu aplikacji.
      allow delete: if false;
    }

    // Reguły dla zadań agentów
    match /agent_tasks/{taskId} {
      // Użytkownik może odczytać zadanie, jeśli jest zalogowany (tymczasowo dla testów)
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}