rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Reguły dla kolekcji 'companies'
    match /companies/{companyId} {
      allow read: if request.auth != null && 
                    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin' || 
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == companyId);
      allow create: if request.auth != null;
      allow update: if request.auth != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin';
      allow delete: if false;
    }

    // Reguły dla kolekcji 'users'
    match /users/{userId} {
      allow read: if request.auth != null &&
                   (request.auth.uid == userId ||
                    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'company-admin' &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.companyId == resource.data.companyId) ||
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin');
      allow create: if true;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }

    // ZMODYFIKOWANE REGUŁY DLA NOWEGO SYSTEMU
    match /tasks/{taskId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null; // Zezwolenie na odczyt dla każdego zalogowanego użytkownika
      allow update: if request.auth != null && request.auth.uid == resource.data.ownerId; // Reguła 'update' pozostaje bez zmian
    }

    // Reguły dla zadań agentów
    match /agent_tasks/{taskId} {
      allow read: if request.auth != null && resource.data.ownerUid == request.auth.uid;
      allow write: if false;
    }

    // Reguły dla zadań agentów V4
    match /agent_tasks_v4/{taskId} {
      allow read: if request.auth != null && resource.data.ownerUid == request.auth.uid;
      allow write: if false;
    }
  }
}